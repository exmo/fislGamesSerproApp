<!DOCTYPE html>
<html>
<head>
<title>SERPRO GAMES</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<script src="js/jquery.js"></script>
<script src="js/jquery.mobile-1.3.1.min.js"></script>
<script src="js/jquery.jsonp-2.4.0.min.js"></script>
<script src="js/fastclick.js"></script>
<script src="js/cordova.js"></script>
<script src="js/barcodescanner.js"></script>
<link rel="stylesheet" href="css/jquery.mobile-1.3.1.min.css">

<!- FastClick -->
<script type="application/javascript" src="js/fastclick.js"></script> 
<script type="application/javascript">
	window.addEventListener('load', function () {
		FastClick.attach(document.body);
	}, false);
</script>

<style type="text/css" >
.header {position:fixed;z-index:10;top:0;width:100%}
.content {padding:45px 15px}
.footer {position:fixed;z-index:10;bottom:0;width:100%}
</style>

</head>
<body>
    	
	<div data-role="page" id="pageLista">
		<div data-role="header" data-theme="b">
			<h1>SERPRO GAME</h1>
		</div>
		<div data-role="content">

			<button id="btLerQRCode">Ler QR Code</button>

			<ul data-role="listview" data-theme="g" id="listaQRCode" data-inset="true">
			</ul>
		</div>
	</div>
	
	<div data-role="page" id="pageCadastro">
		<div data-role="header" data-theme="b">
			<h1>SERPRO GAME</h1>
		</div>
		<div data-role="content">
			<form id="formCadastro">
				<div data-role="fieldcontain">
					<label for="nome">Nome</label> 
					<input type="text" id="nome" required>
				</div>
				
				<div data-role="fieldcontain">
					<label for="email">E-mail</label>
					<input type="email" id="email" required>
				</div>
				
				<div data-role="fieldcontain">
					<label for="telefone">Telefone</label> 
					<input type="tel" id="telefone" required>
				</div>
				
				<input type="button" id="btnCadastrar" value="Cadastrar" />
			</form>
		</div>
	</div>

	<div data-role="page" id="pageQRCodeInfo" data-theme="b" data-close-btn="none">
		<div data-role="header" data-theme="b">
			<h1>SERPRO GAME</h1>
		</div>	
		<div data-role="content">
			<div id="textoInfo">xxxx</div>
			<a href="#pageLista" data-role="button" data-rel="back" data-theme="c">Fechar</a>
		</div>
	</div>

	<div data-role="page" id="pageQRCodeDesafio" data-theme="b" data-close-btn="none">
		<div data-role="header" data-theme="b">
			<h1>SERPRO GAME</h1>
		</div>	
		<div data-role="content">
			<form id="formDesafio" action="#">
			    <input type="hidden" id="qrCodeId"/>
				<div id="pergunta">xxxx</div>				
				<input type="text" id="resposta" required>
				<input type="button" data-theme="b" id="responder" value="Responder"/>
				<a href="#pageLista" data-role="button" data-rel="back" data-theme="c">Fechar</a>				
			</form>
		</div>
	</div>
		
	<div data-role="page" id="pageQRCodeDesafioME" data-theme="b" data-close-btn="none">
		<div data-role="header" data-theme="b">
			<h1>SERPRO GAME</h1>
		</div>	
		<div data-role="content">
			<form id="formDesafioME" action="#">
			    <input type="hidden" id="qrCodeIdME"/>				
				<fieldset data-role="controlgroup" id="grupoRadioButton"> 
				<legend>Resposta:</legend>
			     	<span id="alternativaASpan">
			     	<input type="radio" name="respostaME" id="alternativaA" value="1" checked="checked" />
			     	<label id="alternativaALabel" for="alternativaA" style="white-space:normal">Cat</label>
					</span>
					<span id="alternativaBSpan">
			     	<input type="radio" name="respostaME" id="alternativaB" value="2" />
			     	<label id="alternativaBLabel" for="alternativaB" style="white-space:normal">Cat</label>
			     	</span>
			     	<span id="alternativaCSpan">
			     	<input type="radio" name="respostaME" id="alternativaC" value="3"  />
			     	<label id="alternativaCLabel" for="alternativaC" style="white-space:normal">Cat</label>
			     	</span>
			     	<span id="alternativaDSpan">
			     	<input type="radio" name="respostaME" id="alternativaD" value="4"  />
			     	<label id="alternativaDLabel" for="alternativaD" style="white-space:normal">Cat</label>
			     	</span>
				</fieldset>
				<input type="button" data-theme="b" id="responderME" value="Responder"/>
				<a href="#pageLista" data-role="button" data-rel="back" data-theme="c">Fechar</a>	
			</form>
		</div>
	</div>
    
</body>

<script>

	var DOMINIO = "http://fislgames-exmo.rhcloud.com";
    //var DOMINIO = "http://192.168.0.162:9000";
    
	var MSG_SEM_INTERNET  = "Sem conexão internet." +
							"Verifique sua configuração de rede e tente novamente mais tarde."

	$(document).ready(function(){
		console.log("document ready");
		$("#btnCadastrar").click(submeterCadastro);	
		$("#btLerQRCode").click(scan);
		$("#responder").click(enviarResposta);
		$("#responderME").click(enviarRespostaME);	
				
		$("#pageCadastro").on("pagebeforeshow", function(event){ 
			$("#email").val(lsGet("email"));
			$("#nome").val(lsGet("nome"));
			$("#telefone").val(lsGet("telefone"));
		});		
	});
		
	$("#pageLista").on("pagebeforeshow", function(event){ 
		//executa sempre
		if(!hasValue(lsGet("email"))){
			changePage("pageCadastro");
		} else {
			montaLista();
		}
	});	
					
	function hasValue(field) {
		return(field != null && field != undefined && $.trim(field) != "");
	}
		
	function lsGet(item) {
		return window.localStorage.getItem(item);
	}
	
	function lsSet(item,val) {
		return window.localStorage.setItem(item,val);
	}	

	function montaLista() {
		var total = 0;
		var email = lsGet("email");
		var nome = lsGet("nome");
		$("#listaQRCode").empty();
		listQRCode(function(lista){
			var bubblePontosStyle = "";
			$.each(lista,function(i,qr){	
				var status = "";
				var pontos = "";
				var bubbleStyle = "";
				if (qr.tipo == 'DESAFIO' || qr.tipo == 'DESAFIOME') {
					pontos = qr.pontos;
					if (qr.acertou != null) {
						if (qr.acertou == 'true') { // desafio resposta certa: verde
							total += pontos; 
							bubbleStyle = "style=\"background: #00FF00;\"";
							bubblePontosStyle = bubbleStyle;
						} else { // desafio resposta errada: vermelho
							bubbleStyle = "style=\"color: #FFFFFF; background: #FF0000;\"";
						}
					}
				} else { // info, url: azul
					bubbleStyle = "style=\"color: #FFFFFF; background: #0000FF;\"";
					pontos = qr.tipo.toLowerCase();
				} 				
				var bubblePontos = "<span class=\"ui-li-count\""+bubbleStyle+">"+pontos+"</span>";
				$("#listaQRCode").append("<li style=\"white-space:normal\"><a class=\"changepage\" onclick='exibirQRCodeInfo("+qr.id+")' href='#'>"+qr.texto+status+bubblePontos+"</a></li>").listview('refresh');
			});
			$("#listaQRCode").append("<li data-theme=\"c\" data-role=\"list-divider\">&nbsp;"+nome+"&nbsp;&lt;"+email+"&gt;"+"<span class=\"ui-li-count\""+bubblePontosStyle+">Pontos: "+total+"</span></li>").listview('refresh');
		});			
	}    

	function changePage(page) {
		$.mobile.changePage("#" + page, {
  			transition : 'fade'
  		});
	}
	
	function showDialog(page) {
		$.mobile.changePage("#" + page, { 
			role: "dialog",
			transiction: "flip" 
		});	
	}

	function scan() {
		
		window.plugins.barcodeScanner.scan(function(result) {

			var texto = result.text;
//			var texto = "SERPRO#INFO#9#Quer ganhar 50 pontos? Compareça à palestra Mobilidade e GEO que começa às 11h na área Casos de sucesso sala 713. Não esqueça de pegar o material na saída para responder a pergunta e saber qual é o próximo desafio. #0";

			if (!hasValue(texto)) {
				return false;
			}
			 			
			if (!texto.match("^SERPRO")) {
				alert("Este QR-Code não pertence ao GAME SERPRO");
				return false;
			}

            salvarQRCode(texto);
                                           
		}, function(error) {
            console.log(error);
			alert("Ocorreu um erro na leitura do QR-Code. Tenta novamente.");
		});
        $.mobile.loading('hide');
	}
    
    function salvarQRCode(textoQRCode){
        var itens = textoQRCode.split("#");
        var tipo = itens[1];
        var id = itens[2];
        
        if(tipo == "JSON"){
            obterQRCode(id);
        }else{
            var texto = itens[3];
            var pontos = itens[4];
            var alternativas = textoQRCode.substring(textoQRCode.indexOf(itens[6]));
            insertQRCode(id,texto,tipo,pontos,alternativas,exibirQRCodeInfo);
        }
    }
    
    function obterQRCode(id){
        $.mobile.loading('show');
        $.jsonp({
                "url": DOMINIO+"/qrcode/json/"+id+"?callback=?",
                "success": function(response, textStatus) {
                    console.log("Obteve o JSON para o qrcode: "+id);
                    console.log("Response: "+response);
                    $.mobile.loading('hide');
                    if (response.status == "ERROR") {
                        alert(response.msgRet);
                    }else{
                        var tipo = response.tipo;
                        var texto = response.texto;
                        var pontos = response.pontuacao;
                        var alternativas = response.alternativas;
                        insertQRCode(id,texto,tipo,pontos,alternativas,exibirQRCodeInfo);                
                    }
	        	},
                "error": function(xOptions, textStatus) {
                    console.log("Falha ao tentar obter o QRCode");
                    $.mobile.loading('hide');
                    alert("Ocorreu um erro na leitura do QR-Code. " + MSG_SEM_INTERNET);
                }
        });
    }
    
	
	function exibirQRCodeInfo(id){
        console.log("Obtendo o QRCode: "+id);
		getQRCodeById(id,function(qrCode){
			
            console.log("Montando a tela para exibir o QRCode: "+qrCode.tipo);
                      
			if(qrCode.tipo == 'DESAFIO' ){
				$("#pergunta").text(qrCode.texto);
				$("#qrCodeId").val(qrCode.id);
				showDialog("pageQRCodeDesafio");
			}else if(qrCode.tipo == 'DESAFIOME' ){

				$("#qrCodeIdME").val(qrCode.id);
				
				var alternativasContainer = $("#formDesafioME");
				var fieldset = $("#grupoRadioButton");
				fieldset.html("");
				fieldset.append( $('<legend>').html(qrCode.texto) );
				
                var alternativas = qrCode.alternativas.split("#");
                alternativas = shuffle(alternativas);
                for (var i = 0; i < alternativas.length; i++) {
                      console.log("Alternativa: "+alternativas[i]);
                      if(alternativas[i].length>0){
                        fieldset.append( $('<input type="radio" />')
                                      .attr('name', 'respostaME')
                                      .attr('value', alternativas[i])
                                      .attr('id', 'alternativa'+i) );
                        fieldset.append( $('<label>')
                                      .attr('for', 'alternativa'+i)
                                      .html(alternativas[i]) );
                      }
                }
				
				alternativasContainer.trigger('create');
				showDialog("pageQRCodeDesafioME");
				
			}else if(qrCode.tipo == 'INFO'){
				$("#textoInfo").text(qrCode.texto);
				showDialog("pageQRCodeInfo");
			}else if(qrCode.tipo == 'URL'){
				window.open(encodeURI(qrCode.texto), '_system');
				montaLista(); //recarrega a lista
			}
		});
	}

	function checkInternet() {
	    var networkState = navigator.connection.type;

	    if (networkState == 'undefined' || networkState == Connection.NONE) {
	    	alert(MSG_SEM_INTERNET);
	    	return false;
	    } 
		return true;	    	
	}
	
	function enviarResposta(){
		if (!hasValue($("#resposta").val())) {
			alert("Preencha a resposta!");
			return false;
		}

		if (!checkInternet()) {
			return false;	
		}

		 $.mobile.loading('show');

		var qrId = $("#qrCodeId").val();
		$.jsonp({
	    	"url": DOMINIO+"/desafio/"+qrId+"/"+ localStorage.email +"/"+$("#resposta").val()+"?callback=?",
	        "success": function(response, textStatus) {
	        	 $.mobile.loading('hide');
	        	if (response.status = "OK") {	        		
        			alert(response.msgRet);
        			if (response.codRet == "OK") {
	        			updateQRCode(qrId, true);
					} else if (response.codRet == "ERRO-RE") {
						updateQRCode(qrId, false);
					}
	        	}
	        	$("#resposta").val("");
	        	changePage("pageLista");
	        },
	        "error": function(xOptions, textStatus) {
	        	 $.mobile.loading('hide');
	        	alert("Ocorreu um erro no Envio da Resposta. " + MSG_SEM_INTERNET);
	        }
	    });
	}
	
	function enviarRespostaME(){
		var resposta = $('input[name=respostaME]:checked').val();
		if (!hasValue(resposta)) {
			alert("Escolha uma alternativa");
			return false;
		}
		
		if (!checkInternet()) {
			return false;	
		}
		
        $.mobile.loading('show');
		var qrId = $("#qrCodeIdME").val();		
		
		$.jsonp({
	    	"url": DOMINIO+"/desafio/"+qrId+"/"+ localStorage.email +"/"+resposta+"?callback=?",
	        "success": function(response, textStatus) {
	        	 $.mobile.loading('hide');
	        	if (response.status = "OK") {	        		
        			alert(response.msgRet);
        			if (response.codRet == "OK") {
	        			updateQRCode(qrId, true);
					} else if (response.codRet == "ERRO-RE") {
						updateQRCode(qrId, false);
					}
	        	}
	        	changePage("pageLista");
	        },
	        "error": function(xOptions, textStatus) {
                $.mobile.loading('hide');
				alert("Ocorreu um erro no Envio da Resposta " + MSG_SEM_INTERNET);
	        }
	    });
	}	
	
	function submeterCadastro() {
        console.log("Submetendo cadastro");
		if ($("#nome").val() == "" || $("#email").val() == "" || $("#telefone").val() == "") {
			alert("Preencha todas as informações");
			return false;
		}
		
		if (!validateEmail($("#email").val())) {
			alert("Informe um endereço de e-mail válido");
			return false;
		}

		if (!checkInternet()) {
			return false;	
		}
        
        $.mobile.loading('show');
		
		var url = DOMINIO+"/usuario/criar/"+$("#email").val()+"/"+$("#nome").val()+"/"+$("#telefone").val()+"?callback=?";
	
        console.log(url);
        
	    $.jsonp({
	    	"url": url,
	        "success": function(response, textStatus) {
                $.mobile.loading('hide');
	        	if (response.codRet == "ERRO") {
	        		alert(response.msgRet);
	        	} else {
			      	lsSet("email",$("#email").val());
		      		lsSet("nome",$("#nome").val());
		      		lsSet("telefone",$("#telefone").val());
				}			      	
		      	changePage("pageLista");
	        },
	        "error": function(xOptions, textStatus) {
                $.mobile.loading('hide');
	        	console.log(textStatus);
                alert("Ocorreu um erro no Cadastramento do Usuário. " + MSG_SEM_INTERNET);
                
	        }
	    });
	}
	
	function validateEmail(email) { 
	    var re = /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA	-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
	    return re.test(email);
	}
                      
    function shuffle(o){ //v1.0
        for(var j, x, i = o.length; i; j = parseInt(Math.random() * i), x = o[--i], o[i] = o[j], o[j] = x);
            return o;
    }
                      
</script>
<script src="js/db.js"></script>

</html>
