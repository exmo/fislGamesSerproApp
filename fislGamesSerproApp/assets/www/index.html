<!DOCTYPE html>
<html>
<head>
<title>PhoneGap</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<script src="js/jquery.js"></script>
<script src="js/jquery.mobile-1.3.1.min.js"></script>
<script src="js/jquery.jsonp-2.4.0.min.js"></script>
<script src="js/fastclick.js"></script>
<script src="js/cordova-2.7.0.js"></script>
<script src="js/barcodescanner.js"></script>
<link rel="stylesheet" href="css/jquery.mobile-1.3.1.min.css">
</head>
<body>
	
	<div data-role="page" id="pageCadastro">
		<div data-role="header" data-theme="b">
			<h1>SERPRO GAME</h1>
		</div>
		<div data-role="content">
			<form id="formCadastro">
				<div data-role="fieldcontain">
					<label for="nome">Nome</label> 
					<input type="text" id="nome" required>
				</div>
				
				<div data-role="fieldcontain">
					<label for="email">E-mail</label>
					<input type="email" id="email" required>
				</div>
				
				<div data-role="fieldcontain">
					<label for="telefone">Telefone</label> 
					<input type="text" id="telefone" required>
				</div>
				
				<input type="button" id="btnCadastrar" value="Cadastrar" />
			</form>


		</div>
		<div data-role="footer" data-theme="b" data-position="fixed">
			<h4>FISL 2013</h4>
		</div>
	</div>
	
	<div data-role="page" id="pageLista">
		<div data-role="header" data-theme="b">
			<h1>SERPRO GAME</h1>
		</div>
		<div data-role="content">

			<button id="btLerQRCode">Ler QR Code</button>

			<ul data-role="listview" data-theme="g" id="listaQRCode" data-inset="true">
			</ul>
		</div>
		<div data-role="footer" data-theme="b" data-position="fixed">
			<h4>FISL 2013</h4>
		</div>
	</div>
	

	
	
	<div data-role="page" id="pageQRCodeDesafio" data-add-back-btn="true"  data-back-btn-text="Voltar">
		<div data-role="header" data-theme="b">
			<h1>SERPRO GAME</h1>
		</div>
		<div data-role="content">
			
			<form id="formDesafio" action="#">
			    <input type="hidden" id="qrCodeId"/>
				<div id="pergunta">xxxx</div>				
				<input type="text" id="resposta" required>
				<input type="button" id="responder" value="Responder"/>
			</form>


		</div>
		<div data-role="footer" data-theme="b" data-position="fixed">
			<h4>FISL 2013</h4>
		</div>
	</div>
	
	<div data-role="page" id="pageQRCodeDesafioME" data-add-back-btn="true"  data-back-btn-text="Voltar">
		<div data-role="header" data-theme="b">
			<h1>SERPRO GAME</h1>
		</div>
		<div data-role="content">
			
			<form id="formDesafioME" action="#">
			    <input type="hidden" id="qrCodeIdME"/>				
				
				<fieldset data-role="controlgroup" id="grupoRadioButton"> 
				<legend>Resposta:</legend>
			     	
			     	<span id="alternativaASpan">
			     	<input type="radio" name="respostaME" id="alternativaA" value="1" checked="checked" />
			     	<label id="alternativaALabel" for="alternativaA" style="white-space:normal">Cat</label>
					</span>
					<span id="alternativaBSpan">
			     	<input type="radio" name="respostaME" id="alternativaB" value="2" />
			     	<label id="alternativaBLabel" for="alternativaB" style="white-space:normal">Cat</label>
			     	</span>
			     	<span id="alternativaCSpan">
			     	<input type="radio" name="respostaME" id="alternativaC" value="3"  />
			     	<label id="alternativaCLabel" for="alternativaC" style="white-space:normal">Cat</label>
			     	</span>
			     	<span id="alternativaDSpan">
			     	<input type="radio" name="respostaME" id="alternativaD" value="4"  />
			     	<label id="alternativaDLabel" for="alternativaD" style="white-space:normal">Cat</label>
			     	</span>
			
				</fieldset>
				
				
				<input type="button" id="responderME" value="Responder"/>
			</form>


		</div>
		<div data-role="footer" data-theme="b" data-position="fixed">
			<h4>FISL 2013</h4>
		</div>
	</div>
	

	<div data-role="page" data-theme="b" id="pageQRCodeInfo" data-add-back-btn="true"  data-back-btn-text="Voltar">
		<div data-role="header" data-theme="b">
			<h1>SERPRO GAME</h1>
		</div>
		<div data-role="content">
			<div id="textoInfo">xxxx</div>
		</div>
		<div data-role="footer" data-position="fixed" data-theme="b">
			<h4>FISL 2013</h4>
		</div>
	</div>


</body>

<script>

	var DOMINIO="http://fislgames-exmo.rhcloud.com";

	$(document).ready(function(){ 
		$("#btnCadastrar").click(submeterCadastro);	
		$("#btLerQRCode").click(scan);
		$("#responder").click(enviarResposta);
		$("#responderME").click(enviarRespostaME);

		var email = window.localStorage.getItem("email");

		if(email != null && email != undefined && email != ""){
			montaLista();
			//$.mobile.changePage("#pageLista");
			changePage("pageLista");
		}

		/*
		$("#pageLista").on("pagebeforeshow", function(event){ 
			alert('vaimostrarlista');
			montaLista();
		});
		*/
	});

	function montaLista() {
		var total = 0;

		var email = window.localStorage.getItem("email");
		var nome = window.localStorage.getItem("nome");

		$("#listaQRCode").empty();
		listQRCode(function(lista){
			$.each(lista,function(i,qr){	
				var status = "";
				var pontos = "";
				var bubbleStyle = "";
				if (qr.tipo == 'DESAFIO' || qr.tipo == 'DESAFIOME') {
					pontos = qr.pontos;
					if (qr.acertou != null) {
						if (qr.acertou == 'true') { // desafio resposta certa: verde
							total += pontos; 
							bubbleStyle = "style=\"background: #00FF00;\"";
						} else { // desafio resposta errada: vermelho
							bubbleStyle = "style=\"color: #FFFFFF; background: #FF0000;\"";
						}
					}
				} else { // info, url: azul
					bubbleStyle = "style=\"color: #FFFFFF; background: #0000FF;\"";
					pontos = qr.tipo.toLowerCase();
				} 				
				var bubblePontos = "<span class=\"ui-li-count\""+bubbleStyle+">"+pontos+"</span>";
				$("#listaQRCode").append("<li style=\"white-space:normal\"><a class=\"changepage\" onclick='exibirQRCodeInfo("+qr.id+")' href='#'>"+qr.texto+status+bubblePontos+"</a></li>").listview('refresh');
			});
			$("#listaQRCode").append("<li data-theme=\"c\" data-role=\"list-divider\">&nbsp;"+nome+"&nbsp;&lt;"+email+"&gt;"+"<span class=\"ui-li-count\">Pontos: "+total+"</span></li>").listview('refresh');
		});			
	}    

	function changePage(page) {
		$.mobile.changePage("#" + page, {
  			transition : 'fade'
  		});
	}

	function scan() {
		
		window.plugins.barcodeScanner.scan(function(result) {
			
			//var itens = "SERPRO#DESAFIOME#14#Quantos órgãos de Governo participam do Comitê de Implementação de Software Livre do Governo Federal? #50#mais de 150#N/A#entre 100 e 149#entre 50 e 99".split("#");

			var itens = result.text.split("#");			
			
			var tipo = itens[1];
			var id = itens[2];
            var texto = itens[3];
			var pontos = itens[4];			
			var a = itens[5];
			var b = itens[6];
			var c = itens[7];
			var d = itens[8];
			
			insertQRCode(id,texto,tipo,pontos,a,b,c,d,exibirQRCodeInfo);
		}, function(error) {
			navigator.notification.activityStop();
			alert("Scanning failed: " + error);
		});
	}
	
	function exibirQRCodeInfo(id){

		getQRCodeById(id,function(qrCode){
			
			if(qrCode.tipo == 'DESAFIO' ){
				$("#pergunta").text(qrCode.texto);
				$("#qrCodeId").val(qrCode.id);
				changePage("pageQRCodeDesafio");
			}else if(qrCode.tipo == 'DESAFIOME' ){
			
				//$("#perguntaME").text(qrCode.texto);
				
				$("#qrCodeIdME").val(qrCode.id);
				
				var alternativasContainer = $("#formDesafioME");
				var fieldset = $("#grupoRadioButton");
				fieldset.html("");
				fieldset.append( $('<legend>').html(qrCode.texto) );
				
				if(qrCode.alternativaA != "N/A"){
					fieldset.append( $('<input type="radio" />').attr('name', 'respostaME').attr('value', qrCode.alternativaA).attr('id', 'alternativaA') );
            		fieldset.append( $('<label>').attr('for', 'alternativaA').html(qrCode.alternativaA) );
				}
				
				if(qrCode.alternativaB != "N/A"){
					fieldset.append( $('<input type="radio" />').attr('name', 'respostaME').attr('value', qrCode.alternativaB).attr('id', 'alternativaB') );
            		fieldset.append( $('<label>').attr('for', 'alternativaB').html(qrCode.alternativaB) );
				}
				
				if(qrCode.alternativaC != "N/A"){
					fieldset.append( $('<input type="radio" />').attr('name', 'respostaME').attr('value', qrCode.alternativaC).attr('id', 'alternativaC') );
            		fieldset.append( $('<label>').attr('for', 'alternativaC').html(qrCode.alternativaC) );
				}
				
				if(qrCode.alternativaD != "N/A"){
					fieldset.append( $('<input type="radio" />').attr('name', 'respostaME').attr('value', qrCode.alternativaD).attr('id', 'alternativaD') );
            		fieldset.append( $('<label>').attr('for', 'alternativaD').html(qrCode.alternativaD) );
				}
				
				alternativasContainer.trigger('create');
				
				changePage("pageQRCodeDesafioME");
				
			}else if(qrCode.tipo == 'INFO'){
				$("#textoInfo").text(qrCode.texto);
				changePage("pageQRCodeInfo");
			}else if(qrCode.tipo == 'URL'){
				window.open(encodeURI(qrCode.texto), '_system');
			}
		});
	}


	function enviarResposta(){
		navigator.notification.activityStart();
		var qrId = $("#qrCodeId").val();
		$.jsonp({
	    	"url": DOMINIO+"/desafio/"+qrId+"/"+ localStorage.email +"/"+$("#resposta").val()+"?callback=?",
	        "success": function(response, textStatus) {
	        	navigator.notification.activityStop();
	        	if (response.status = "OK") {	        		
        			alert(response.msgRet);
        			if (response.codRet == "OK") {
	        			updateQRCode(qrId, true);
					} else if (response.codRet == "ERRO-RE") {
						updateQRCode(qrId, false);
					}
	        	}
	        	$("#resposta").val("");
	        	exibirTelaLista();
	        },
	        "error": function(xOptions, textStatus) {
	        	navigator.notification.activityStop();
				alert("erro " + xOptions + " " + textStatus);
	        }
	    });		
	}
	
	
	
	function enviarRespostaME(){
		navigator.notification.activityStart();
		var qrId = $("#qrCodeIdME").val();		
		var resposta = $('input[name=respostaME]:checked').val();
		
		$.jsonp({
	    	"url": DOMINIO+"/desafio/"+qrId+"/"+ localStorage.email +"/"+resposta+"?callback=?",
	        "success": function(response, textStatus) {
	        	navigator.notification.activityStop();
	        	if (response.status = "OK") {	        		
        			alert(response.msgRet);
        			if (response.codRet == "OK") {
	        			updateQRCode(qrId, true);
					} else if (response.codRet == "ERRO-RE") {
						updateQRCode(qrId, false);
					}
	        	}
	        	exibirTelaLista();
	        },
	        "error": function(xOptions, textStatus) {
	        	navigator.notification.activityStop();
				alert("erro " + xOptions + " " + textStatus);
	        }
	    });
	}	
	
	
	function exibirTelaLista(){
	
		montaLista();
	
		changePage("pageLista");	
	}

	function submeterCadastro() {
		navigator.notification.activityStart();	
		
		var url = DOMINIO+"/usuario/criar/"+$("#email").val()+"/"+$("#nome").val()+"/"+$("#telefone").val()+"?callback=?";
	
	    $.jsonp({
	    	"url": url,
	        "success": function(response, textStatus) {
	        	navigator.notification.activityStop();
	        	if (response.codRet == "ERRO") {
	        		alert(response.msgRet);
	        	} else {
			      	window.localStorage.setItem("email",$("#email").val());
		      		window.localStorage.setItem("nome",$("#nome").val());
		      		window.localStorage.setItem("telefone",$("#telefone").val());
						}			      	
		      	exibirTelaLista();
	        },
	        "error": function(xOptions, textStatus) {
	        	navigator.notification.activityStop();
	        	alert("Erro: "+textStatus);
	        }
	    });
	}
</script>
<script src="js/db.js"></script>

</html>
